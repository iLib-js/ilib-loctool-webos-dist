var ilib=require("./ilib.js"),Locale=require("./Locale.js"),JSUtils=require("./JSUtils.js"),Path=require("./Path.js"),ISet=require("./ISet.js"),Utils={};function getPropertyName(basename,pathname,root){var bits=[basename];return root&&(bits=bits.concat(root.split("/"))),pathname&&(bits=bits.concat(pathname.split("/"))),bits.join("_")}function getPropertyNameFromFile(basename,filepath,root){var dir=Path.dirname(filepath);return getPropertyName(basename,"."===dir||"/"===dir||".."===dir?void 0:dir,root)}function dataNotExists(basename,pathname,root){return!ilib.data[getPropertyNameFromFile(basename,pathname,root)]}Utils.getSublocales=function(locale){var ret=["root"],loc="string"==typeof locale?new Locale(locale):locale,lang=loc.getLanguage(),region=loc.getRegion(),script=loc.getScript(),variant=loc.getVariant();return lang&&ret.push(lang),region&&ret.push("und-"+region),lang&&(script&&ret.push(lang+"-"+script),region&&ret.push(lang+"-"+region)),region&&variant&&ret.push("und-"+region+"-"+variant),lang&&(script&&region&&ret.push(lang+"-"+script+"-"+region),region&&variant&&ret.push(lang+"-"+region+"-"+variant),script&&region&&variant&&ret.push(lang+"-"+script+"-"+region+"-"+variant)),ret},Utils.mergeLocData=function(prefix,locale,replaceArrays,returnOne,root){var mostSpecific,data=void 0,loc=locale||new Locale();return mostSpecific=data={},Utils.getSublocales(loc).forEach(function(l){var property=getPropertyName(prefix,"root"===l?void 0:l.replace(/-/g,"/"),root);ilib.data[property]&&(returnOne?mostSpecific=ilib.data[property]:data=JSUtils.merge(data,ilib.data[property],replaceArrays))}),returnOne?mostSpecific:data},Utils.getLocFiles=function(locale,name){var filename=name||"resources.json",loc=locale||new Locale();return Utils.getSublocales(loc).map(function(l){return"root"===l?filename:Path.join(l.replace(/-/g,"/"),filename)})},Utils._callLoadData=function(files,sync,params,root,callback){return"function"==typeof ilib._load?ilib._load(files,sync,params,callback):"object"==typeof ilib._load&&"function"==typeof ilib._load.loadFiles?ilib._load.loadFiles(files,sync,params,callback,root):void 0},Utils.loadData=function(params){var root,basename,name="resources.json",locale=new Locale(ilib.getLocale()),sync=!1,type=void 0,loadParams={},callback=void 0,nonlocale=!1,replace=!1;if(!params||"function"!=typeof params.callback)throw"Utils.loadData called without a callback. It must have a callback to work.";if(params.name&&(name=params.name),params.locale&&(locale="string"==typeof params.locale?new Locale(params.locale):params.locale),params.type&&(type=params.type),params.loadParams&&(loadParams=params.loadParams),params.sync&&(sync=params.sync),params.nonlocale&&(nonlocale=!!params.nonlocale),"boolean"==typeof params.replace&&(replace=params.replace),root=params.root,callback=params.callback,!type){var dot=name.lastIndexOf(".");type=-1!==dot?name.substring(dot+1):"text"}void 0===ilib.data.cache&&(ilib.data.cache={}),void 0===ilib.data.cache.fileSet&&(ilib.data.cache.fileSet=new ISet);var data,returnOne=loadParams&&loadParams.returnOne||"json"!==type;if(basename=name.substring(0,name.lastIndexOf(".")).replace(/[\.:\(\)\/\\\+\-]/g,"_"),ilib._cacheMerged){void 0===ilib.data.cache.merged&&(ilib.data.cache.merged={});var spec=(!nonlocale&&locale.getSpec().replace(/-/g,"_")||"root")+","+basename+","+String(JSUtils.hashCode(loadParams));if(void 0!==ilib.data.cache.merged[spec])return void callback(ilib.data.cache.merged[spec])}if(void 0!==ilib._load){var files=nonlocale?[name||"resources.json"]:Utils.getLocFiles(locale,name);if((files=files.filter(ilib.bind(this,function(file){return!ilib.data.cache.fileSet.has(Path.join(root,file))&&dataNotExists(basename,file,root)}))).length)return void Utils._callLoadData(files,sync,loadParams,root,ilib.bind(this,function(arr){for(var i=0;i<files.length;i++){if(arr[i]){var property=nonlocale?basename:getPropertyNameFromFile(basename,files[i],root);ilib.data[property]||(ilib.data[property]=arr[i])}ilib.data.cache.fileSet.add(Path.join(root,files[i]))}nonlocale?data=ilib.data[basename]:(data=Utils.mergeLocData(basename,locale,replace,returnOne,root),ilib._cacheMerged&&(ilib.data.cache.merged[spec]=data)),callback(data)}))}nonlocale?data=ilib.data[basename]:(data=Utils.mergeLocData(basename,locale,replace,returnOne,root),ilib._cacheMerged&&(ilib.data.cache.merged[spec]=data)),callback(data)},module.exports=Utils;