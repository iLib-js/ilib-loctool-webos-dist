var ilib=require("../index.js"),SearchUtils=require("./SearchUtils.js"),MathUtils=require("./MathUtils.js"),Locale=require("./Locale.js"),LocaleInfo=require("./LocaleInfo.js"),TimeZone=require("./TimeZone.js"),IDate=require("./IDate.js"),IslamicRataDie=require("./IslamicRataDie.js"),IslamicCal=require("./IslamicCal.js"),IslamicDate=function(params){this.cal=new IslamicCal(),(params=params||{}).timezone&&(this.timezone=params.timezone),params.locale&&(this.locale="string"==typeof params.locale?new Locale(params.locale):params.locale),this.timezone?this._init(params):this.locale?new LocaleInfo(this.locale,{sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(li){this.li=li,this.timezone=li.getTimeZone(),this._init(params)})}):(this.timezone="local",this._init(params))};IslamicDate.prototype=new IDate({noinstance:!0}),IslamicDate.prototype.parent=IDate,(IslamicDate.prototype.constructor=IslamicDate).prototype._init=function(params){params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond?(this.year=parseInt(params.year,10)||0,this.month=parseInt(params.month,10)||1,this.day=parseInt(params.day,10)||1,this.hour=parseInt(params.hour,10)||0,this.minute=parseInt(params.minute,10)||0,this.second=parseInt(params.second,10)||0,this.millisecond=parseInt(params.millisecond,10)||0,this.dayOfYear=parseInt(params.dayOfYear,10),"boolean"==typeof params.dst&&(this.dst=params.dst),this.rd=this.newRd(this),new TimeZone({id:this.timezone,sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(tz){this.tz=tz,this.offset=this.tz._getOffsetMillisWallTime(this)/864e5,0!==this.offset&&(this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset})),this._init2(params)})})):this._init2(params)},IslamicDate.prototype._init2=function(params){this.rd||(this.rd=this.newRd(params),this._calcDateComponents()),"function"==typeof params.onLoad&&params.onLoad(this)},IslamicDate.cumMonthLengths=[0,30,59,89,118,148,177,207,236,266,295,325,354],IslamicDate.GregorianDiff=227015,IslamicDate.prototype.newRd=function(params){return new IslamicRataDie(params)},IslamicDate.prototype._calcYear=function(rd){return Math.floor((30*rd+10646)/10631)},IslamicDate.prototype._calcDateComponents=function(){var remainder,rd=this.rd.getRataDie();this.year=this._calcYear(rd),void 0===this.offset&&(this.year=this._calcYear(rd),this.tz||(this.tz=new TimeZone({id:this.timezone})),this.offset=this.tz.getOffsetMillis(this)/864e5),0!==this.offset&&(rd+=this.offset,this.year=this._calcYear(rd)),remainder=rd-this.newRd({year:this.year,month:1,day:1,hour:0,minute:0,second:0,millisecond:0}).getRataDie()+1,this.dayOfYear=remainder,this.month=SearchUtils.bsearch(remainder,IslamicDate.cumMonthLengths),remainder-=IslamicDate.cumMonthLengths[this.month-1],this.day=Math.floor(remainder),remainder-=this.day,remainder=Math.round(864e5*remainder),this.hour=Math.floor(remainder/36e5),remainder-=36e5*this.hour,this.minute=Math.floor(remainder/6e4),remainder-=6e4*this.minute,this.second=Math.floor(remainder/1e3),remainder-=1e3*this.second,this.millisecond=remainder},IslamicDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.rd.getRataDie()+(this.offset||0));return MathUtils.mod(rd-2,7)},IslamicDate.prototype.getDayOfYear=function(){return IslamicDate.cumMonthLengths[this.month-1]+this.day},IslamicDate.prototype.getEra=function(){return this.year<1?-1:1},IslamicDate.prototype.getCalendar=function(){return"islamic"},IDate._constructors.islamic=IslamicDate,module.exports=IslamicDate;