var ilib=require("../index.js"),SearchUtils=require("./SearchUtils.js"),MathUtils=require("./MathUtils.js"),Locale=require("./Locale.js"),LocaleInfo=require("./LocaleInfo.js"),TimeZone=require("./TimeZone.js"),IDate=require("./IDate.js"),JulianRataDie=require("./JulianRataDie.js"),JulianCal=require("./JulianCal.js"),JulianDate=function(params){this.cal=new JulianCal(),(params=params||{}).timezone&&(this.timezone=params.timezone),params.locale&&(this.locale="string"==typeof params.locale?new Locale(params.locale):params.locale),this.timezone?this._init(params):this.locale?new LocaleInfo(this.locale,{sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(li){this.li=li,this.timezone=li.getTimeZone(),this._init(params)})}):(this.timezone="local",this._init(params))};JulianDate.prototype=new IDate({noinstance:!0}),JulianDate.prototype.parent=IDate,(JulianDate.prototype.constructor=JulianDate).prototype._init=function(params){params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond?(this.year=parseInt(params.year,10)||0,this.month=parseInt(params.month,10)||1,this.day=parseInt(params.day,10)||1,this.hour=parseInt(params.hour,10)||0,this.minute=parseInt(params.minute,10)||0,this.second=parseInt(params.second,10)||0,this.millisecond=parseInt(params.millisecond,10)||0,this.dayOfYear=parseInt(params.dayOfYear,10),"boolean"==typeof params.dst&&(this.dst=params.dst),this.rd=this.newRd(this),new TimeZone({id:this.timezone,sync:params.sync,loadParams:params.loadParams,onLoad:ilib.bind(this,function(tz){this.tz=tz,this.offset=this.tz._getOffsetMillisWallTime(this)/864e5,0!==this.offset&&(this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset})),this._init2(params)})})):this._init2(params)},JulianDate.prototype._init2=function(params){this.rd||(this.rd=this.newRd(params),this._calcDateComponents()),"function"==typeof params.onLoad&&params.onLoad(this)},JulianDate.prototype.newRd=function(params){return new JulianRataDie(params)},JulianDate.prototype._calcYear=function(rd){var year=Math.floor((4*(Math.floor(rd)-1)+1464)/1461);return year<=0?year-1:year},JulianDate.prototype._calcDateComponents=function(){var remainder,cumulative,rd=this.rd.getRataDie();this.year=this._calcYear(rd),void 0===this.offset&&(this.year=this._calcYear(rd),this.tz||(this.tz=new TimeZone({id:this.timezone})),this.offset=this.tz.getOffsetMillis(this)/864e5),0!==this.offset&&(rd+=this.offset,this.year=this._calcYear(rd)),remainder=rd+1-this.newRd({year:this.year,month:1,day:1,hour:0,minute:0,second:0,millisecond:0}).getRataDie(),cumulative=this.cal.isLeapYear(this.year)?JulianCal.cumMonthLengthsLeap:JulianCal.cumMonthLengths,this.month=SearchUtils.bsearch(Math.floor(remainder),cumulative),remainder-=cumulative[this.month-1],this.day=Math.floor(remainder),remainder-=this.day,remainder=Math.round(864e5*remainder),this.hour=Math.floor(remainder/36e5),remainder-=36e5*this.hour,this.minute=Math.floor(remainder/6e4),remainder-=6e4*this.minute,this.second=Math.floor(remainder/1e3),remainder-=1e3*this.second,this.millisecond=remainder},JulianDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.rd.getRataDie()+(this.offset||0));return MathUtils.mod(rd-2,7)},JulianDate.prototype.getCalendar=function(){return"julian"},IDate._constructors.julian=JulianDate,module.exports=JulianDate;